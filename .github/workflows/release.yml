name: Release

concurrency: release

on:
  workflow_dispatch:
    inputs:
      number:
        description: Version number (2.55.x - just type the 'x' part)
        type: string
        required: false
      versiontype:
        type: choice
        description: Whether the build specified is an Alpha/Beta/Gamma/Release
        options:
          - release
        required: true
        default: release
      full_release:
        type: boolean
        description: Full Version (i.e. NOT a nightly)
        default: true
      sentry:
        type: boolean
        description: Perform a sentry release
        default: true

jobs:
  create-tag:
    runs-on: ubuntu-latest
    outputs:
      release-tag: ${{ steps.make-vars.outputs.release-tag }}
      release-name: ${{ steps.make-vars.outputs.release-name }}
      previous-release-tag: ${{ steps.make-vars.outputs.previous-release-tag }}
    steps:
      - name: git clone
        uses: actions/checkout@v4
      - run: git fetch --prune --unshallow --tags
      - id: make-vars
        run: |
          python3 .github/workflows/print-release-name-vars.py \
            --github_org=${{ github.repository_owner }} \
            --full_release=${{ github.event.inputs.full_release }} \
            --version_type=${{ github.event.inputs.versiontype }} \
            --number=${{ inputs.number }}

      - name: Setup Sentry CLI
        uses: mathieu-bour/setup-sentry-cli@dbbd0776d55f6e0e5cd7e81fa1a80f4fd0c60369 # v2.0.0
        if: inputs.sentry
        with:
          version: '2.20.6'
          token: ${{ secrets.SENTRY_TOKEN }}
          organization: zeldaclassic
          project: zelda-classic
      - run: sentry-cli --version
        if: inputs.sentry
      - run: sentry-cli --log-level=DEBUG releases new 'zelda-classic@${{ steps.make-vars.outputs.release-tag }}'
        if: inputs.sentry

  build-release:
    needs: ["create-tag"]
    strategy:
      matrix:
        include:
          - runs-on: windows-2022
            arch: x64
            compiler: msvc
            config: RelWithDebInfo
            sentry: ${{ inputs.sentry }}
          - runs-on: windows-2022
            arch: win32
            compiler: msvc
            config: RelWithDebInfo
            sentry: ${{ inputs.sentry }}
          - runs-on: macos-13
            arch: intel
            compiler: clang
            config: RelWithDebInfo
            sentry: ${{ inputs.sentry }}
          - runs-on: ubuntu-22.04
            arch: x64
            compiler: clang
            config: RelWithDebInfo
            sentry: ${{ inputs.sentry }}
      fail-fast: false
    uses: ./.github/workflows/build.yml
    with:
      runs-on: ${{ matrix.runs-on }}
      arch: ${{ matrix.arch }}
      compiler: ${{ matrix.compiler }}
      config: ${{ matrix.config }}
      sentry: ${{ matrix.sentry }}
      release-tag: ${{ needs.create-tag.outputs.release-tag }}
      release-name: ${{ needs.create-tag.outputs.release-name }}
      cache: false
      number: ${{ inputs.number }}
      versiontype: ${{ inputs.versiontype }}
      full_release: ${{ inputs.full_release }}
    secrets: inherit

  publish:
    needs:
      - create-tag
      - build-release
    if: ${{ always() }}
    runs-on: ubuntu-22.04
    steps:
      - name: git clone
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: release-packages

      - name: Generate changelog
        run: python scripts/generate_changelog.py --format markdown --from ${{ needs.create-tag.outputs.previous-release-tag }} --for-nightly=${{ github.event.inputs.full_release != 'true' }} > new_changelog.md

      - name: Release
        uses: softprops/action-gh-release@6cbd405e2c4e67a21c47fa9e383d020e4e28b836 # v2.3.3
        with:
          name: ${{ needs.create-tag.outputs.release-name }}
          tag_name: ${{ needs.create-tag.outputs.release-tag }}
          target_commitish: ${{ github.sha }}
          files: release-packages/**/*
          prerelease: ${{ !inputs.full_release }}
          fail_on_unmatched_files: true
          generate_release_notes: false
          body_path: new_changelog.md

      - name: Setup Sentry CLI
        if: inputs.sentry
        uses: mathieu-bour/setup-sentry-cli@dbbd0776d55f6e0e5cd7e81fa1a80f4fd0c60369 # v2.0.0
        with:
          version: '2.20.6'
          token: ${{ secrets.SENTRY_TOKEN }}
          organization: zeldaclassic
          project: zelda-classic
      - name: Finalize sentry
        if: inputs.sentry
        run: |
          sentry-cli --log-level=DEBUG releases set-commits 'zelda-classic@${{ needs.create-tag.outputs.release-tag }}' --auto --ignore-missing
          sentry-cli --log-level=DEBUG releases finalize 'zelda-classic@${{ needs.create-tag.outputs.release-tag }}'

      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.WEBSITE_REPO_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: 'ZQuestClassic',
              repo: 'zquestclassic.com',
              workflow_id: 'deploy.yml',
              ref: 'main',
            })
            await github.rest.actions.createWorkflowDispatch({
              owner: 'ZQuestClassic',
              repo: 'web.zquestclassic.com',
              workflow_id: 'deploy.yml',
              ref: 'main',
            })

      - name: Setup s3cmd
        uses: s3-actions/s3cmd@4e3a53c3e9313f573ff3f69aec7a772366f2f8f5
        with:
          provider: digitalocean
          region: nyc3
          access_key: ${{ secrets.S3_ACCESS_KEY }}
          secret_key: ${{ secrets.S3_SECRET_KEY }}

      - name: Upload to s3 bucket
        run: python scripts/upload_releases_to_s3.py
